# Phase 4 – SAP CPI Groovy Coding Standards & Reusability Patterns

### 1. Purpose of This Document
This document defines mandatory coding standards, structure, and reusability rules for all SAP CPI Groovy scripts generated by the agentic system.

It ensures that every script is:
- SAP CPI compliant
- Consistent across generations
- Easy to read and maintain
- Optimized but safe
- Free from copy-paste patterns
- Enterprise-ready

This document is authoritative and frozen.

### 2. Non-Negotiable Rules
- Strict SAP CPI Groovy only
- One entry method per script
- Reusable helper methods only
- No duplicated logic
- Explicit null handling
- Standardized logging usage
- Readable over clever

Violation of any rule → validation failure.

### 3. Mandatory Script Structure
Every script must follow this exact high-level structure:
1. Imports
2. Script Header Comment
3. `processData(Message message)` entry method
4. Logging helper
5. Core processing methods
6. Utility/helper methods
7. Error handling

No reordering is allowed.

### 4. Imports & Dependencies
#### 4.1 Allowed Imports
Only SAP CPI–supported imports:
```groovy
import com.sap.gateway.ip.core.customdev.util.Message
import groovy.json.JsonSlurper
import groovy.json.JsonOutput
```

#### 4.2 Disallowed Imports
- File I/O
- Threading
- Networking
- Reflection
- Custom libraries

Validation Agent must reject unsupported imports.

### 5. Entry Method Standard
#### 5.1 Single Entry Point
Every script must implement:
`Message processData(Message message)`

**Rules:**
- No overloaded entry methods
- No logic outside this method except helpers

#### 5.2 Entry Method Responsibilities
The entry method must:
- Initialize logging
- Log `START` stage
- Delegate logic to helper methods
- Handle exceptions
- Log `END` stage
- Return message

### 6. Core Processing Pattern
#### 6.1 Delegation Rule
Business logic must not live in `processData`.

**Allowed:**
`processData → validate → transform → enrich → setBody`

**Disallowed:**
- Inline payload parsing
- Inline validation logic
- Inline transformation logic

### 7. Helper Method Design Rules
#### 7.1 Single Responsibility
Each helper method must:
- Do one thing
- Have a clear name
- Be reusable

**Bad:** `validateAndTransformPayload()`
**Good:** `validatePayload()`, `transformPayload()`

#### 7.2 Method Signature Rules
- Explicit parameters
- No hidden dependencies
- No global state

**Allowed:** `Map parseJsonPayload(String payload)`
**Disallowed:** `def parse()`

### 8. Reusability Patterns
#### 8.1 Utility Methods (Mandatory Where Applicable)
Common utilities must be extracted:
- Payload parsing
- Header/property retrieval
- Null-safe value access
- Logging helpers

#### 8.2 Avoiding Copy-Paste
If logic appears more than once:
- Extract helper method
- Refactor immediately

Validation Agent must detect repeated code blocks.

### 9. Null-Safety Standards
#### 9.1 Mandatory Null Handling
Every external input must be validated:
- Payload
- Headers
- Properties

**Allowed:**
```groovy
if (!payload) {
    throw new IllegalArgumentException("Payload is empty")
}
```
**Disallowed:** `payload.field.value`

### 10. Error Handling Standards
#### 10.1 Exception Strategy
- Catch exceptions only at entry method or logical boundaries
- Always log before rethrow
- Never swallow exceptions

#### 10.2 Business vs Technical Errors
- **Business validation** → `IllegalArgumentException`
- **Technical failure** → propagate original exception

### 11. Logging Integration (Mandatory)
- Logging helper must be used
- No direct `MessageLog` access
- No inline logging logic
- All stages must be logged

Validation fails if logging framework is bypassed.

### 12. Documentation Rules (Code-Level)
#### 12.1 Header Comment
Must include:
- Script purpose
- Integration context
- Assumptions
- Logging behavior

#### 12.2 Method Comments
Required for:
- Public helpers
- Non-obvious logic

Avoid:
- Obvious comments
- Redundant explanations

### 13. Performance Guidelines
- Cache payload once
- Avoid repeated parsing
- Avoid logging inside loops
- Avoid unnecessary object creation

Optimization Agent enforces these rules.

### 14. ADK Agent Responsibilities
| Agent | Responsibility |
| :--- | :--- |
| **Code Generator** | Follow structure strictly |
| **Best Practices** | Enforce design patterns |
| **Validation Agents** | Reject violations |
| **Optimization Agent** | Improve without changing behavior |
| **Documentation Agent** | Explain structure clearly |

### 15. Validation Checklist (Mandatory)
Script fails if:
- Logic exists outside helpers
- Repeated code detected
- Null safety missing
- Logging framework bypassed
- Structure violated

### 16. Phase Status
✅ Phase 4 – Frozen
