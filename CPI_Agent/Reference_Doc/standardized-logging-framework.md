# Phase 3 – Standardized Logging Framework for SAP CPI Groovy Scripts

### 1. Purpose of This Document
This document defines a single, standardized, reusable logging framework for all SAP CPI Groovy scripts generated by the agentic system.

The framework must:
- Work strictly within SAP CPI Groovy
- Be reusable across multiple scripts and iFlows
- Support stage-wise logging
- Be performance-aware
- Be easy to understand and maintain
- Be automatically applied by the agentic pipeline

This document is authoritative and frozen.

### 2. Design Goals
- **Single Logging Utility**: One reusable logging helper per script
- **Consistent Log Format**: Same structure across all generated scripts
- **Stage-Based Logging**: Entry, exit, error, and checkpoints
- **Performance Safety**: Logging must not degrade throughput
- **CPI-Native**: Use only `MessageLog` and supported APIs

### 3. Core Logging Strategy
#### 3.1 Logging Levels (Logical, Not Runtime)
SAP CPI does not support log levels natively, so levels are logical, not enforced.

| Level | Usage |
| :--- | :--- |
| **INFO** | High-level flow steps |
| **DEBUG** | Payload snapshots (conditional) |
| **WARN** | Recoverable issues |
| **ERROR** | Exceptions / failures |

Levels are represented via message text and structure, not APIs.

### 4. Logging Utility Design
#### 4.1 Logging Helper Structure
Each Groovy script must define one logging helper class or set of methods.

**Mandatory Helper Methods**
- `logInfo`
- `logDebug`
- `logWarn`
- `logError`

**Design Rules**
Helper must:
- Accept `Message`
- Lazily access `MessageLog`
- Never throw exceptions
- Be self-contained

#### 4.2 MessageLog Access Pattern (Critical)
```groovy
def messageLog = messageLogFactory?.getMessageLog(message)
```

**Rules**
- Always use safe navigation (`?.`)
- Never assume `MessageLog` exists
- Logging must silently fail if `MessageLog` is unavailable

### 5. Stage-Based Logging Model
Each script must log clearly defined stages.

#### 5.1 Mandatory Stages
| Stage | Description |
| :--- | :--- |
| **START** | Script entry point |
| **INPUT** | Payload received |
| **PROCESS** | Main logic execution |
| **OUTPUT** | Payload after processing |
| **END** | Script exit |
| **ERROR** | Exception handling |

#### 5.2 Stage Naming Convention
`[SCRIPT_NAME] [STAGE] [LEVEL] Message`

**Example**
`[ValidatePayload] [PROCESS] [INFO] Validating mandatory fields`

### 6. Payload Logging Policy (Performance-Safe)
#### 6.1 Default Behavior
- Do not log full payloads
- Log metadata only (size, type, key fields)

#### 6.2 Conditional Payload Logging
Payload logging is allowed only when:
- Debug flag is enabled via message property
- Payload size is below defined threshold

**Property Example**
`LOG_DEBUG = true`

### 7. Error Logging & Exception Handling
#### 7.1 Error Logging Rules
Always log:
- Exception message
- Stage name

Never log:
- Sensitive data
- Full payloads on error (unless debug enabled)

#### 7.2 Exception Handling Pattern
- Catch exceptions at top-level
- Log error
- Rethrow exception (do not swallow)

### 8. Agent Responsibilities (ADK-Aligned)
- **Best Practices Agent**:
    - Inject logging helper skeleton
    - Ensure logging hooks exist at all stages
- **Optimization Agent**:
    - Remove unnecessary logging
    - Ensure payload logging is conditional
- **Documentation Agent**:
    - Explain logging behavior
    - Document how to enable debug logging
- **Validation Agents**:
    - Fail if:
        - Logging helper is missing
        - Unsafe `MessageLog` access is used
        - Payload logged unconditionally

### 9. Logging Context Integration
Logging helper must integrate with shared context:

| Context Section | Usage |
| :--- | :--- |
| **RequestContext** | Script name |
| **AssumptionsContext** | Log assumptions once |
| **ValidationContext** | Log failures |
| **DecisionLog** | Reference execution decisions |

### 10. Reusability & Copy-Paste Avoidance
**Rule**: Logging logic must not be duplicated inline.

**Allowed patterns:**
- One helper per script
- Reusable helper methods only

**Disallowed patterns:**
- Inline `messageLog.addAttachmentAsString` everywhere
- Repeating `try/catch` blocks for logging

### 11. Validation Checklist (Mandatory)
A script fails validation if:
- No logging helper exists
- Logging is done directly without helper
- `MessageLog` is accessed unsafely
- Payload logging is unconditional

### 12. Latency Considerations
- Logging must be: lazy, conditional, and minimal by default
- Debug logging must be explicitly enabled
- No logging inside tight loops unless justified

### 13. Phase Status
✅ Phase 3 – Frozen
